{% extends "base.html" %}

{% block title %}Dashboard - Sistema de Gestión de Personas{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-tachometer-alt"></i> Dashboard
            <small class="text-muted">Bienvenido, {{ user.username }}</small>
            
            <!-- Auto-refresh controls -->
            <div class="float-end">
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-success" id="start-refresh" onclick="startAutoRefresh()" title="Activar actualización automática">
                        <i class="fas fa-play"></i> Auto
                    </button>
                    <button type="button" class="btn btn-outline-danger" id="stop-refresh" onclick="stopAutoRefresh()" style="display:none;" title="Detener actualización automática">
                        <i class="fas fa-stop"></i> Stop
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="manual-refresh" onclick="manualRefresh()" title="Actualizar manualmente">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button type="button" class="btn btn-outline-warning" id="force-refresh" onclick="forceRefresh()" title="Forzar actualización (limpia cache)">
                        <i class="fas fa-sync"></i> Forzar
                    </button>
                </div>
            </div>
        </h1>
        {% if session.token and session.token.startswith('temp-') %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <strong>Modo Temporal Activado:</strong> La autenticación está funcionando en modo temporal mientras se resuelven problemas de conectividad con el backend.
        </div>
        {% endif %}
    </div>
</div>

{% if stats %}
<!-- Key Metrics -->
<div class="row mb-4" data-animate="fade-in">
    <div class="col-lg-3 col-md-6 mb-3" data-animate="slide-in-left" data-delay="0">
        <div class="card border-primary stats-card">
            <div class="card-body text-center">
                <i class="fas fa-users fa-2x text-primary mb-2"></i>
                <h3 class="card-title counter" data-target="{{ stats.total_personas or 0 }}">0</h3>
                <p class="card-text text-muted">Total Personas</p>
            </div>
        </div>
    </div>
    
    {% if stats.estadisticas_edad %}
    <div class="col-lg-3 col-md-6 mb-3" data-animate="slide-in-left" data-delay="100">
        <div class="card border-success stats-card">
            <div class="card-body text-center">
                <i class="fas fa-birthday-cake fa-2x text-success mb-2"></i>
                <h3 class="card-title counter" data-target="{{ stats.estadisticas_edad.promedio }}">0</h3>
                <p class="card-text text-muted">Edad Promedio</p>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3" data-animate="slide-in-left" data-delay="200">
        <div class="card border-info stats-card">
            <div class="card-body text-center">
                <i class="fas fa-arrow-down fa-2x text-info mb-2"></i>
                <h3 class="card-title counter" data-target="{{ stats.estadisticas_edad.minima }}">0</h3>
                <p class="card-text text-muted">Edad Mínima</p>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3" data-animate="slide-in-left" data-delay="300">
        <div class="card border-warning stats-card">
            <div class="card-body text-center">
                <i class="fas fa-arrow-up fa-2x text-warning mb-2"></i>
                <h3 class="card-title counter" data-target="{{ stats.estadisticas_edad.maxima }}">0</h3>
                <p class="card-text text-muted">Edad Máxima</p>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Charts -->
<div class="row" data-animate="slide-in-right" data-delay="400">
    {% if stats.por_genero %}
    <div class="col-lg-6 mb-4">
        <div class="card" data-loading="fade">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie"></i> Distribución por Género
                </h5>
            </div>
            <div class="card-body">
                <div id="genderChart" class="chart-container"></div>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if stats.por_tipo_documento %}
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar"></i> Distribución por Tipo de Documento
                </h5>
            </div>
            <div class="card-body">
                <div id="documentChart"></div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% if stats.por_grupo_edad %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar"></i> Distribución por Grupo de Edad
                </h5>
            </div>
            <div class="card-body">
                <div id="ageChart"></div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Youngest Person -->
{% if stats.persona_mas_joven %}
<div class="row">
    <div class="col-12">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-star"></i> Persona más joven registrada
                </h5>
            </div>
            <div class="card-body">
                <h6>{{ stats.persona_mas_joven.primer_nombre }} {{ stats.persona_mas_joven.apellidos }}</h6>
                <p class="mb-0">Edad: {{ stats.persona_mas_joven.edad }} años</p>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% else %}
<!-- No Data Message -->
<div class="row">
    <div class="col-12">
        <div class="alert alert-info text-center">
            <i class="fas fa-info-circle fa-2x mb-3"></i>
            <h4>No hay datos disponibles</h4>
            <p>Comienza agregando personas al sistema para ver las estadísticas.</p>
            <a href="{{ url_for('crear_persona') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Crear Primera Persona
            </a>
        </div>
    </div>
</div>
{% endif %}

<!-- Quick Actions -->
<div class="row mt-4">
    <div class="col-12">
        <h4>Acciones Rápidas</h4>
        <div class="row">
            <div class="col-lg-3 col-md-6 mb-3">
                <a href="{{ url_for('crear_persona') }}" class="card text-decoration-none">
                    <div class="card-body text-center">
                        <i class="fas fa-plus fa-2x text-primary mb-2"></i>
                        <h6 class="card-title">Crear Persona</h6>
                        <p class="card-text text-muted small">Agregar nueva persona al sistema</p>
                    </div>
                </a>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <a href="{{ url_for('consultar_personas') }}" class="card text-decoration-none">
                    <div class="card-body text-center">
                        <i class="fas fa-search fa-2x text-success mb-2"></i>
                        <h6 class="card-title">Consultar</h6>
                        <p class="card-text text-muted small">Buscar y consultar personas</p>
                    </div>
                </a>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <a href="{{ url_for('consulta_nlp') }}" class="card text-decoration-none">
                    <div class="card-body text-center">
                        <i class="fas fa-robot fa-2x text-info mb-2"></i>
                        <h6 class="card-title">Consulta IA</h6>
                        <p class="card-text text-muted small">Preguntas en lenguaje natural</p>
                    </div>
                </a>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <a href="{{ url_for('consultar_logs') }}" class="card text-decoration-none">
                    <div class="card-body text-center">
                        <i class="fas fa-clipboard-list fa-2x text-warning mb-2"></i>
                        <h6 class="card-title">Ver Logs</h6>
                        <p class="card-text text-muted small">Auditoría y registro de actividades</p>
                    </div>
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
{% if stats %}
// Gender Chart
{% if stats.por_genero %}
var genderData = [
    {% for genero, count in stats.por_genero.items() %}
    { values: [{{ count }}], labels: ['{{ genero }}'], type: 'pie', name: '{{ genero }}' },
    {% endfor %}
];

var genderLayout = {
    height: 300,
    showlegend: true,
    margin: { t: 0, b: 0, l: 0, r: 0 }
};

Plotly.newPlot('genderChart', [
    {
        values: [{% for count in stats.por_genero.values() %}{{ count }},{% endfor %}],
        labels: [{% for genero in stats.por_genero.keys() %}'{{ genero }}',{% endfor %}],
        type: 'pie'
    }
], genderLayout);
{% endif %}

// Document Chart
{% if stats.por_tipo_documento %}
Plotly.newPlot('documentChart', [
    {
        x: [{% for tipo in stats.por_tipo_documento.keys() %}'{{ tipo }}',{% endfor %}],
        y: [{% for count in stats.por_tipo_documento.values() %}{{ count }},{% endfor %}],
        type: 'bar',
        marker: { color: '#28a745' }
    }
], {
    height: 300,
    margin: { t: 20, b: 40, l: 40, r: 20 },
    xaxis: { title: 'Tipo de Documento' },
    yaxis: { title: 'Cantidad' }
});
{% endif %}

// Age Chart
{% if stats.por_grupo_edad %}
Plotly.newPlot('ageChart', [
    {
        x: [{% for grupo in stats.por_grupo_edad.keys() %}'{{ grupo }}',{% endfor %}],
        y: [{% for count in stats.por_grupo_edad.values() %}{{ count }},{% endfor %}],
        type: 'bar',
        marker: { color: '#17a2b8' }
    }
], {
    height: 300,
    margin: { t: 20, b: 60, l: 40, r: 20 },
    xaxis: { title: 'Grupo de Edad' },
    yaxis: { title: 'Cantidad' }
});
{% endif %}

// Auto-refresh functionality
let refreshInterval;

function refreshDashboard() {
    // Mostrar indicador de carga
    showLoadingIndicator();
    
    fetch('/api/dashboard/stats', {
        method: 'GET',
        headers: {
            'Cache-Control': 'no-cache, no-store, must-revalidate',
            'Pragma': 'no-cache'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(stats => {
        console.log('Stats received:', stats);
        
        // Update all stats cards
        updateAllStatsCards(stats);
        
        // Update all charts
        updateAllCharts(stats);
        
        // Update youngest person card if exists
        updateYoungestPerson(stats);
        
        hideLoadingIndicator();
        console.log('Dashboard refreshed successfully at', new Date().toLocaleTimeString());
    })
    .catch(error => {
        console.error('Error refreshing dashboard:', error);
        hideLoadingIndicator();
        showRefreshError();
    });
}

function showLoadingIndicator() {
    // Agregar indicador visual de carga en las tarjetas
    const statsCards = document.querySelectorAll('.stats-card .card-body');
    statsCards.forEach(card => {
        if (!card.querySelector('.refresh-spinner')) {
            const spinner = document.createElement('div');
            spinner.className = 'refresh-spinner position-absolute top-0 end-0 mt-2 me-2';
            spinner.innerHTML = '<i class="fas fa-spinner fa-spin text-primary"></i>';
            card.style.position = 'relative';
            card.appendChild(spinner);
        }
    });
}

function hideLoadingIndicator() {
    const spinners = document.querySelectorAll('.refresh-spinner');
    spinners.forEach(spinner => spinner.remove());
}

function showRefreshError() {
    const errorToast = document.createElement('div');
    errorToast.className = 'toast position-fixed top-0 end-0 mt-3 me-3';
    errorToast.style.zIndex = '9999';
    errorToast.innerHTML = `
        <div class="toast-header bg-danger text-white">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong class="me-auto">Error de actualización</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">
            No se pudieron actualizar las estadísticas. Intenta de nuevo.
        </div>
    `;
    document.body.appendChild(errorToast);
    
    const bsToast = new bootstrap.Toast(errorToast);
    bsToast.show();
    
    // Remover después de que se oculte
    errorToast.addEventListener('hidden.bs.toast', () => {
        errorToast.remove();
    });
}

function updateAllStatsCards(stats) {
    // Update total personas
    const totalElements = document.querySelectorAll('[data-target]');
    totalElements.forEach(element => {
        const target = element.dataset.target;
        let newValue = 0;
        
        // Determinar qué estadística actualizar basado en el contenido de la card
        const cardBody = element.closest('.card-body');
        const cardText = cardBody ? cardBody.textContent.toLowerCase() : '';
        
        if (cardText.includes('total personas')) {
            newValue = stats.total_personas || 0;
        } else if (cardText.includes('edad promedio') && stats.estadisticas_edad) {
            newValue = Math.round(stats.estadisticas_edad.promedio || 0);
        } else if (cardText.includes('edad mínima') && stats.estadisticas_edad) {
            newValue = stats.estadisticas_edad.minima || 0;
        } else if (cardText.includes('edad máxima') && stats.estadisticas_edad) {
            newValue = stats.estadisticas_edad.maxima || 0;
        }
        
        // Actualizar si el valor cambió
        const currentValue = parseInt(element.textContent) || 0;
        if (currentValue !== newValue) {
            // Animar el cambio
            if (window.contentManager) {
                window.contentManager.animateCounter(element, newValue, 800);
            } else {
                element.textContent = newValue;
            }
            highlightChange(element.closest('.card'));
        }
    });
}

function updateAllCharts(stats) {
    // Update gender chart
    if (stats.por_genero && document.getElementById('genderChart')) {
        const labels = Object.keys(stats.por_genero);
        const values = Object.values(stats.por_genero);
        
        try {
            Plotly.redraw('genderChart', [{
                values: values,
                labels: labels,
                type: 'pie',
                marker: {
                    colors: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1']
                }
            }]);
        } catch (error) {
            console.error('Error updating gender chart:', error);
        }
    }
    
    // Update document type chart
    if (stats.por_tipo_documento && document.getElementById('documentChart')) {
        const labels = Object.keys(stats.por_tipo_documento);
        const values = Object.values(stats.por_tipo_documento);
        
        try {
            Plotly.redraw('documentChart', [{
                x: labels,
                y: values,
                type: 'bar',
                marker: { 
                    color: '#28a745',
                    line: {
                        color: '#1e7e34',
                        width: 1
                    }
                }
            }]);
        } catch (error) {
            console.error('Error updating document chart:', error);
        }
    }
    
    // Update age group chart
    if (stats.por_grupo_edad && document.getElementById('ageChart')) {
        const labels = Object.keys(stats.por_grupo_edad);
        const values = Object.values(stats.por_grupo_edad);
        
        try {
            Plotly.redraw('ageChart', [{
                x: labels,
                y: values,
                type: 'bar',
                marker: { 
                    color: '#17a2b8',
                    line: {
                        color: '#117a8b',
                        width: 1
                    }
                }
            }]);
        } catch (error) {
            console.error('Error updating age chart:', error);
        }
    }
}

function updateYoungestPerson(stats) {
    if (stats.persona_mas_joven) {
        const youngestCard = document.querySelector('.border-success .card-body');
        if (youngestCard) {
            const nameElement = youngestCard.querySelector('h6');
            const ageElement = youngestCard.querySelector('p');
            
            if (nameElement && ageElement) {
                const newName = `${stats.persona_mas_joven.primer_nombre} ${stats.persona_mas_joven.apellidos}`;
                const newAge = `Edad: ${stats.persona_mas_joven.edad} años`;
                
                if (nameElement.textContent !== newName || ageElement.textContent !== newAge) {
                    nameElement.textContent = newName;
                    ageElement.textContent = newAge;
                    highlightChange(youngestCard.closest('.card'));
                }
            }
        }
    }
}

function updateStatsCards(stats) {
    // Función legacy - ahora usa updateAllStatsCards
    updateAllStatsCards(stats);
}

function updateCharts(stats) {
    // Función legacy - ahora usa updateAllCharts
    updateAllCharts(stats);
}

function highlightChange(element) {
    element.style.backgroundColor = '#d4edda';
    setTimeout(() => {
        element.style.backgroundColor = '';
    }, 1000);
}

// Control buttons for auto-refresh
function startAutoRefresh() {
    if (refreshInterval) return;
    
    // Refresh más frecuente: cada 10 segundos en lugar de 30
    refreshInterval = setInterval(refreshDashboard, 10000);
    
    // Add indicator
    const indicator = document.createElement('div');
    indicator.id = 'refresh-indicator';
    indicator.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Actualizando cada 10s';
    indicator.style.cssText = 'position: fixed; top: 70px; right: 10px; background: #28a745; color: white; padding: 8px 12px; border-radius: 20px; z-index: 1000; font-size: 11px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); backdrop-filter: blur(10px);';
    document.body.appendChild(indicator);
    
    document.getElementById('start-refresh').style.display = 'none';
    document.getElementById('stop-refresh').style.display = 'inline-block';
    
    // Hacer un refresh inmediato al activar
    refreshDashboard();
}

function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
    
    const indicator = document.getElementById('refresh-indicator');
    if (indicator) {
        indicator.remove();
    }
    
    document.getElementById('start-refresh').style.display = 'inline-block';
    document.getElementById('stop-refresh').style.display = 'none';
}

// Manual refresh
function manualRefresh() {
    refreshDashboard();
    
    // Show temporary feedback
    const btn = document.getElementById('manual-refresh');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Actualizando...';
    btn.disabled = true;
    
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }, 1000);
}

// Force refresh (invalidates cache)
function forceRefresh() {
    showLoadingIndicator();
    
    fetch('/api/dashboard/refresh', {
        method: 'POST',
        headers: {
            'Cache-Control': 'no-cache, no-store, must-revalidate',
            'Pragma': 'no-cache',
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(stats => {
        console.log('Force refresh completed:', stats);
        
        // Update all components
        updateAllStatsCards(stats);
        updateAllCharts(stats);
        updateYoungestPerson(stats);
        
        hideLoadingIndicator();
        
        // Show success toast
        showSuccessToast('Dashboard actualizado con datos frescos!');
        
        console.log('Dashboard force refreshed successfully at', new Date().toLocaleTimeString());
    })
    .catch(error => {
        console.error('Error force refreshing dashboard:', error);
        hideLoadingIndicator();
        showRefreshError();
    });
}

function showSuccessToast(message) {
    const successToast = document.createElement('div');
    successToast.className = 'toast position-fixed top-0 end-0 mt-3 me-3';
    successToast.style.zIndex = '9999';
    successToast.innerHTML = `
        <div class="toast-header bg-success text-white">
            <i class="fas fa-check-circle me-2"></i>
            <strong class="me-auto">Actualización exitosa</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">
            ${message}
        </div>
    `;
    document.body.appendChild(successToast);
    
    const bsToast = new bootstrap.Toast(successToast);
    bsToast.show();
    
    // Remover después de que se oculte
    successToast.addEventListener('hidden.bs.toast', () => {
        successToast.remove();
    });
}

// Animar contadores cuando la página cargue
document.addEventListener('DOMContentLoaded', function() {
    // Configurar localStorage listener para refresh entre ventanas
    setupCrossWindowRefresh();
    
    // Auto-iniciar el refresh si hay datos
    if (document.querySelector('.stats-card')) {
        startAutoRefresh();
    }
    
    // Animar contadores numéricos
    const counters = document.querySelectorAll('.counter');
    
    // Configurar intersection observer para animar cuando entren en viewport
    const observerOptions = {
        threshold: 0.5,
        rootMargin: '0px 0px -50px 0px'
    };
    
    const counterObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting && !entry.target.classList.contains('animated')) {
                entry.target.classList.add('animated');
                const target = parseInt(entry.target.dataset.target) || 0;
                
                // Usar el ContentManager para animar
                if (window.contentManager) {
                    window.contentManager.animateCounter(entry.target, target, 1500);
                }
                
                counterObserver.unobserve(entry.target);
            }
        });
    }, observerOptions);
    
    counters.forEach(counter => {
        counterObserver.observe(counter);
    });
    
    // Animar tarjetas en secuencia
    const cards = document.querySelectorAll('.stats-card');
    if (window.contentManager && cards.length > 0) {
        setTimeout(() => {
            window.contentManager.animateCardsSequence(Array.from(cards), 150);
        }, 500);
    }
});

// Sistema de comunicación entre ventanas para actualizaciones inmediatas
function setupCrossWindowRefresh() {
    // Escuchar eventos de localStorage para actualizaciones entre ventanas
    window.addEventListener('storage', function(e) {
        if (e.key === 'dashboard_refresh_trigger') {
            console.log('Refresh triggered from another window');
            refreshDashboard();
            // Limpiar el trigger
            localStorage.removeItem('dashboard_refresh_trigger');
        }
    });
    
    // Escuchar eventos de focus para refresh automático
    window.addEventListener('focus', function() {
        // Hacer refresh cuando la ventana vuelve a tener foco
        console.log('Window gained focus, refreshing dashboard');
        refreshDashboard();
    });
}

// Función para disparar refresh desde otras páginas
function triggerDashboardRefresh() {
    // Disparar refresh en esta ventana si es el dashboard
    if (window.location.pathname === '/dashboard' || window.location.pathname === '/') {
        refreshDashboard();
    }
    
    // Disparar refresh en otras ventanas del dashboard
    localStorage.setItem('dashboard_refresh_trigger', Date.now().toString());
    
    // Limpiar después de un momento
    setTimeout(() => {
        localStorage.removeItem('dashboard_refresh_trigger');
    }, 1000);
}

</script>
{% endif %}
{% endblock %}
